{% extends 'layouts/default.html' %}
{% block title %}Shopping Cart - {{ APP_NAME }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
        Shopping Cart
    </h1>
    <p class="page-subtitle">Review your items before checkout.</p>
</div>

{% if cart_items %}
<div class="cart-layout">
    <!-- Cart Items -->
    <div class="cart-items-container">
        <div class="card">
            <div class="card-header">
                <h2>Cart Items ({{ cart_count }} {% if cart_count == 1 %}item{% else %}items{% endif %})</h2>
                <button class="btn btn-sm btn-danger" id="clear-cart-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Clear Cart
                </button>
            </div>
            
            <div class="cart-items" id="cart-items">
                {% for item in cart_items %}
                <div class="cart-item" data-product-id="{{ item.product_id }}">
                    <div class="cart-item-image">
                        {% if item.image_url %}
                        <img src="{{ item.image_url }}" alt="{{ item.name }}">
                        {% else %}
                        <div class="product-placeholder">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                        </div>
                        {% endif %}
                    </div>
                    <div class="cart-item-details">
                        <h3 class="cart-item-name">{{ item.name }}</h3>
                        <p class="cart-item-price">${{ item.price|floatformat:2 }} each</p>
                    </div>
                    <div class="cart-item-quantity">
                        <button class="quantity-btn minus" data-product-id="{{ item.product_id }}">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>
                        <input type="number" class="quantity-input" value="{{ item.quantity }}" min="1" data-product-id="{{ item.product_id }}">
                        <button class="quantity-btn plus" data-product-id="{{ item.product_id }}">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="cart-item-subtotal">
                        $<span class="item-subtotal">{{ item.subtotal|floatformat:2 }}</span>
                    </div>
                    <button class="cart-item-remove" data-product-id="{{ item.product_id }}">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Checkout Section -->
    <div class="cart-summary-container">
        <!-- Checkout Form -->
        <div class="card checkout-card">
            <h2>Checkout</h2>
            <form id="checkout-form">
                {% csrf_token %}
                <div class="form-section">
                    <h3>Shipping Address</h3>
                    <div class="form-group">
                        <textarea id="shipping_address" name="shipping_address" rows="3" required placeholder="Enter your shipping address">{{ customer_address|default:'' }}</textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Payment Method</h3>
                    <div class="payment-options">
                        <label class="payment-option">
                            <input type="radio" name="payment_method" value="credit_card" checked>
                            <div class="payment-option-content">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                    <line x1="1" y1="10" x2="23" y2="10"></line>
                                </svg>
                                <span>Credit Card</span>
                            </div>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="payment_method" value="paypal">
                            <div class="payment-option-content">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M7 11l5-5 5 5M7 17l5-5 5 5"></path>
                                </svg>
                                <span>PayPal</span>
                            </div>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="payment_method" value="cash">
                            <div class="payment-option-content">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                </svg>
                                <span>Cash on Delivery</span>
                            </div>
                        </label>
                    </div>
                </div>
            </form>
        </div>

        <!-- Order Summary -->
        <div class="card cart-summary">
            <h2>Order Summary</h2>
            
            <div class="summary-row">
                <span>Subtotal</span>
                <span id="cart-subtotal">${{ cart_subtotal|floatformat:2 }}</span>
            </div>
            
            <div class="summary-row">
                <span>Tax ({{ tax_rate|floatformat:0 }}%)</span>
                <span id="cart-tax">${{ cart_tax|floatformat:2 }}</span>
            </div>
            
            <div class="summary-row">
                <span>Shipping</span>
                <span id="cart-shipping">
                    {% if cart_subtotal >= free_shipping_threshold %}
                    <span class="free-shipping">FREE</span>
                    {% else %}
                    ${{ cart_shipping|floatformat:2 }}
                    {% endif %}
                </span>
            </div>

            {% if cart_subtotal < free_shipping_threshold %}
            <div class="free-shipping-notice">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="3" width="15" height="13"></rect>
                    <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                    <circle cx="5.5" cy="18.5" r="2.5"></circle>
                    <circle cx="18.5" cy="18.5" r="2.5"></circle>
                </svg>
                Add ${{ remaining_for_free_shipping|floatformat:2 }} more for FREE shipping!
            </div>
            {% endif %}
            
            <div class="summary-row total">
                <span>Total</span>
                <span id="cart-total">${{ cart_total|floatformat:2 }}</span>
            </div>

            <button type="button" class="btn btn-primary btn-block" id="place-order-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                Place Order
            </button>

            <a href="{% url 'products' %}" class="btn btn-block" style="margin-top: 0.5rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Continue Shopping
            </a>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal" id="confirm-order-modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h2>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                Confirm Order
            </h2>
            <button class="modal-close" id="confirm-modal-close">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom: 1.5rem;">Are you sure you want to place this order?</p>
            <div class="order-summary-mini">
                <div class="summary-row">
                    <span>Total Amount:</span>
                    <span class="total-amount">${{ cart_total|floatformat:2 }}</span>
                </div>
                <div class="summary-row">
                    <span>Payment Method:</span>
                    <span id="confirm-payment-method">Credit Card</span>
                </div>
            </div>
            <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                <button type="button" class="btn btn-block" id="cancel-order-btn">Cancel</button>
                <button type="button" class="btn btn-primary btn-block" id="confirm-order-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Confirm Order
                </button>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- Empty Cart -->
<div class="empty-cart">
    <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
        <circle cx="9" cy="21" r="1"></circle>
        <circle cx="20" cy="21" r="1"></circle>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
    </svg>
    <h2>Your cart is empty</h2>
    <p>Looks like you haven't added any items to your cart yet.</p>
    <a href="{% url 'products' %}" class="btn btn-primary">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
        </svg>
        Browse Products
    </a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// URLs for cart operations
window.cartUrls = {
    update: '{% url "api_cart_update" %}',
    remove: '{% url "api_cart_remove" %}',
    clear: '{% url "api_cart_clear" %}',
    checkout: '{% url "checkout" %}',
    ordersPage: '{% url "orders" %}'
};
window.csrfToken = '{{ csrf_token }}';
</script>
<script src="/static/js/customer/cart.js?v=20251212-006"></script>
{% endblock %}
