{% extends 'layouts/default.html' %}
{% block title %}Reports - {{ APP_NAME }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
        </svg>
        Reports & Analytics
    </h1>
    <p class="page-subtitle">View detailed reports and analytics for your store.</p>
</div>

<!-- Date Range Selector -->
<div class="card" style="margin-bottom: 1.5rem;">
    <form method="GET" class="date-range-form">
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
            <div style="flex: 1; min-width: 150px;">
                <label for="period">Quick Select</label>
                <select id="period" name="period">
                    <option value="today" {% if period == 'today' %}selected{% endif %}>Today</option>
                    <option value="week" {% if period == 'week' %}selected{% endif %}>This Week</option>
                    <option value="month" {% if period == 'month' or not period %}selected{% endif %}>This Month</option>
                    <option value="quarter" {% if period == 'quarter' %}selected{% endif %}>This Quarter</option>
                    <option value="year" {% if period == 'year' %}selected{% endif %}>This Year</option>
                    <option value="custom" {% if period == 'custom' %}selected{% endif %}>Custom Range</option>
                </select>
            </div>
            <div style="flex: 1; min-width: 150px;" id="date-from-group" {% if period != 'custom' %}style="display: none;"{% endif %}>
                <label for="date_from">From</label>
                <input type="date" id="date_from" name="date_from" value="{{ date_from|default:'' }}">
            </div>
            <div style="flex: 1; min-width: 150px;" id="date-to-group" {% if period != 'custom' %}style="display: none;"{% endif %}>
                <label for="date_to">To</label>
                <input type="date" id="date_to" name="date_to" value="{{ date_to|default:'' }}">
            </div>
            <div>
                <button type="submit" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    Generate Report
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Key Metrics -->
<div class="metrics">
    <div class="metric-card success">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
        </div>
        <h3>Total Revenue</h3>
        <div class="value">${{ report.total_revenue|floatformat:0 }}</div>
        {% if report.revenue_change %}
        <span class="metric-change {% if report.revenue_change > 0 %}positive{% else %}negative{% endif %}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                {% if report.revenue_change > 0 %}
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
                {% else %}
                <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
                <polyline points="17 18 23 18 23 12"></polyline>
                {% endif %}
            </svg>
            {{ report.revenue_change|floatformat:1 }}% vs previous period
        </span>
        {% endif %}
    </div>

    <div class="metric-card info">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
        </div>
        <h3>Orders</h3>
        <div class="value">{{ report.total_orders }}</div>
        <span class="metric-subtext">{{ report.average_order_value|floatformat:2 }} avg. order value</span>
    </div>

    <div class="metric-card warning">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg>
        </div>
        <h3>Products Sold</h3>
        <div class="value">{{ report.products_sold }}</div>
        <span class="metric-subtext">{{ report.unique_products }} unique products</span>
    </div>

    <div class="metric-card">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>
        </div>
        <h3>New Customers</h3>
        <div class="value">{{ report.new_customers }}</div>
        <span class="metric-subtext">{{ report.returning_customers }} returning</span>
    </div>
</div>

<!-- Charts -->
<div class="charts-row">
    <div class="card chart-card large">
        <div class="card-header">
            <h2>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
                Revenue Over Time
            </h2>
        </div>
        <div class="chart-container" style="height: 300px;">
            <canvas id="revenue-chart"></canvas>
        </div>
    </div>
</div>

<div class="charts-row">
    <div class="card chart-card">
        <div class="card-header">
            <h2>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                    <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                </svg>
                Sales by Category
            </h2>
        </div>
        <div class="chart-container">
            <canvas id="category-chart"></canvas>
        </div>
    </div>

    <div class="card chart-card">
        <div class="card-header">
            <h2>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                    <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                </svg>
                Order Status Distribution
            </h2>
        </div>
        <div class="chart-container">
            <canvas id="status-chart"></canvas>
        </div>
    </div>
</div>

<!-- Top Products & Customers -->
<div class="dashboard-grid">
    <div class="card">
        <div class="card-header">
            <h2>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
                Top Selling Products
            </h2>
        </div>
        {% if report.top_products %}
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Product</th>
                    <th>Sold</th>
                    <th>Revenue</th>
                </tr>
            </thead>
            <tbody>
                {% for product in report.top_products %}
                <tr>
                    <td>
                        <span class="rank-badge {% if forloop.counter <= 3 %}top{% endif %}">{{ forloop.counter }}</span>
                    </td>
                    <td>{{ product.name }}</td>
                    <td>{{ product.quantity_sold }}</td>
                    <td><strong>${{ product.revenue|floatformat:2 }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty-message">No data available for this period.</p>
        {% endif %}
    </div>

    <div class="card">
        <div class="card-header">
            <h2>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                </svg>
                Top Customers
            </h2>
        </div>
        {% if report.top_customers %}
        <table>
            <thead>
                <tr>
                    <th>Customer</th>
                    <th>Orders</th>
                    <th>Total Spent</th>
                </tr>
            </thead>
            <tbody>
                {% for customer in report.top_customers %}
                <tr>
                    <td>{{ customer.first_name }} {{ customer.last_name }}</td>
                    <td>{{ customer.order_count }}</td>
                    <td><strong>${{ customer.total_spent|floatformat:2 }}</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty-message">No data available for this period.</p>
        {% endif %}
    </div>
</div>

<!-- Export Options -->
<div class="card">
    <div class="card-header">
        <h2>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Export Report
        </h2>
    </div>
    <div class="export-options">
        <a href="?{% if period %}period={{ period }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}&export=csv" class="btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            Export as CSV
        </a>
        <a href="?{% if period %}period={{ period }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}&export=pdf" class="btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
            Export as PDF
        </a>
        <button class="btn" onclick="window.print();">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                <rect x="6" y="14" width="12" height="8"></rect>
            </svg>
            Print Report
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
window.chartData = {
    revenueLabels: {{ chart_data.revenue_labels|safe }},
    revenueData: {{ chart_data.revenue_data|safe }},
    categoryLabels: {{ chart_data.category_labels|safe }},
    categoryData: {{ chart_data.category_data|safe }},
    statusData: {{ chart_data.status_data|safe }}
};
</script>
<script src="/static/js/admin/reports.js?v=20251212-002"></script>
{% endblock %}
