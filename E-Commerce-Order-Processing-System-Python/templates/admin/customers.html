{% extends 'layouts/default.html' %}
{% block title %}Customers - {{ APP_NAME }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        Customers
    </h1>
    <p class="page-subtitle">View and manage your customer base.</p>
</div>

<!-- Customer Stats -->
<div class="metrics mini">
    <div class="metric-card">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        </div>
        <h3>Total Customers</h3>
        <div class="value">{{ stats.total_customers }}</div>
    </div>
    <div class="metric-card success">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        </div>
        <h3>Active Customers</h3>
        <div class="value">{{ stats.active_customers }}</div>
    </div>
    <div class="metric-card info">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
            </svg>
        </div>
        <h3>New This Month</h3>
        <div class="value">{{ stats.new_this_month }}</div>
    </div>
    <div class="metric-card warning">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
        </div>
        <h3>Total Revenue</h3>
        <div class="value">${{ stats.total_revenue|floatformat:0 }}</div>
    </div>
</div>

<!-- Search and Filters -->
<div class="card" style="margin-bottom: 1.5rem;">
    <form method="GET" class="filters-form">
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
            <div style="flex: 2; min-width: 200px;">
                <label for="search">Search</label>
                <input type="text" id="search" name="search" placeholder="Name, email, or phone..." value="{{ search|default:'' }}">
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label for="sort">Sort By</label>
                <select id="sort" name="sort">
                    <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest First</option>
                    <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>Oldest First</option>
                    <option value="orders" {% if sort == 'orders' %}selected{% endif %}>Most Orders</option>
                    <option value="spent" {% if sort == 'spent' %}selected{% endif %}>Highest Spent</option>
                    <option value="name" {% if sort == 'name' %}selected{% endif %}>Name (A-Z)</option>
                </select>
            </div>
            <div>
                <button type="submit" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                    Search
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Customers Table -->
<div class="card">
    <div class="card-header">
        <h2>All Customers ({{ total_customers }})</h2>
    </div>

    {% if customers %}
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>Customer</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Orders</th>
                    <th>Total Spent</th>
                    <th>Joined</th>
                    <th style="width: 100px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for customer in customers %}
                <tr>
                    <td>
                        <div class="customer-cell">
                            <div class="customer-avatar">
                                {{ customer.first_name.0 }}{{ customer.last_name.0 }}
                            </div>
                            <div class="customer-name">
                                <strong>{{ customer.first_name }} {{ customer.last_name }}</strong>
                                <small>@{{ customer.user.username }}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <a href="mailto:{{ customer.user.email }}">{{ customer.user.email }}</a>
                    </td>
                    <td>{{ customer.phone|default:"-" }}</td>
                    <td>
                        <span class="badge">{{ customer.order_count }}</span>
                    </td>
                    <td><strong>${{ customer.total_spent|floatformat:2 }}</strong></td>
                    <td>{{ customer.user.created_at|date:"M j, Y" }}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="{% url 'admin_customer_detail' customer.id %}" class="btn btn-sm" title="View Details">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination-container">
        <div class="pagination">
            {% if page > 1 %}
            <a href="?page={{ page|add:'-1' }}{% if search %}&search={{ search }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="btn btn-sm">&laquo; Previous</a>
            {% endif %}

            {% for p in page_range %}
                {% if p == page %}
                <span class="btn btn-sm btn-primary">{{ p }}</span>
                {% else %}
                <a href="?page={{ p }}{% if search %}&search={{ search }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="btn btn-sm">{{ p }}</a>
                {% endif %}
            {% endfor %}

            {% if page < total_pages %}
            <a href="?page={{ page|add:'1' }}{% if search %}&search={{ search }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="btn btn-sm">Next &raquo;</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
        </svg>
        <h3>No customers found</h3>
        <p>{% if search %}Try adjusting your search criteria.{% else %}No customers have registered yet.{% endif %}</p>
    </div>
    {% endif %}
</div>
{% endblock %}
