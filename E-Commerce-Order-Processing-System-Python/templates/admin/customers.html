{% extends 'layouts/default.html' %}
{% block title %}Customers - {{ APP_NAME }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        Customers
    </h1>
    <p class="page-subtitle">View and manage your customer base.</p>
</div>

<!-- Customer Stats -->
<div class="metrics mini">
    <div class="metric-card">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        </div>
        <h3>Total Customers</h3>
        <div class="value">{{ stats.total_customers }}</div>
    </div>
    <div class="metric-card success">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        </div>
        <h3>Active Customers</h3>
        <div class="value">{{ stats.active_customers }}</div>
    </div>
    <div class="metric-card info">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
            </svg>
        </div>
        <h3>New This Month</h3>
        <div class="value">{{ stats.new_this_month }}</div>
    </div>
    <div class="metric-card warning">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
            </svg>
        </div>
        <h3>Total Revenue</h3>
        <div class="value">${{ stats.total_revenue|floatformat:0 }}</div>
    </div>
</div>

<!-- Search and Filters -->
<div class="card" style="margin-bottom: 1.5rem;">
    <form method="GET" class="filters-form">
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
            <div style="flex: 2; min-width: 200px;">
                <label for="search">Search</label>
                <input type="text" id="search" name="search" placeholder="Name, email, or phone..." value="{{ search|default:'' }}">
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label for="sort">Sort By</label>
                <select id="sort" name="sort">
                    <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest First</option>
                    <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>Oldest First</option>
                    <option value="orders" {% if sort == 'orders' %}selected{% endif %}>Most Orders</option>
                    <option value="spent" {% if sort == 'spent' %}selected{% endif %}>Highest Spent</option>
                    <option value="name" {% if sort == 'name' %}selected{% endif %}>Name (A-Z)</option>
                </select>
            </div>
            <div>
                <button type="submit" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                    Search
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Customers Table -->
<div class="card">
    <div class="card-header">
        <h2>All Customers ({{ total_customers }})</h2>
    </div>

    {% if customers %}
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th>Customer</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Orders</th>
                    <th>Total Spent</th>
                    <th>Joined</th>
                    <th style="width: 80px; text-align: center;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for customer in customers %}
                <tr>
                    <td>
                        <div class="customer-name">
                            <strong>{{ customer.first_name }} {{ customer.last_name }}</strong>
                            <small>@{{ customer.user.username }}</small>
                        </div>
                    </td>
                    <td>
                        <a href="mailto:{{ customer.user.email }}">{{ customer.user.email }}</a>
                    </td>
                    <td>{{ customer.phone|default:"-" }}</td>
                    <td>
                        <span class="badge">{{ customer.order_count }}</span>
                    </td>
                    <td><strong>${{ customer.total_spent|floatformat:2 }}</strong></td>
                    <td>{{ customer.user.created_at|date:"M j, Y" }}</td>
                    <td style="text-align: center;">
                        <div class="kebab-menu">
                            <button class="kebab-btn" title="Actions">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="5" r="1"></circle>
                                    <circle cx="12" cy="12" r="1"></circle>
                                    <circle cx="12" cy="19" r="1"></circle>
                                </svg>
                            </button>
                            <div class="kebab-dropdown">
                                <a href="{% url 'admin_customer_detail' customer.id %}" class="kebab-item">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                    View Customer
                                </a>
                                <button class="kebab-item danger delete-customer-btn" data-customer-id="{{ customer.id }}" data-customer-name="{{ customer.first_name }} {{ customer.last_name }}" data-customer-email="{{ customer.user.email }}">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                    Delete Customer
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination-container">
        <div class="pagination">
            {% if page > 1 %}
            <a href="?page={{ page|add:'-1' }}{% if search %}&search={{ search }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="btn btn-sm">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Previous
            </a>
            {% else %}
            <button class="btn btn-sm" disabled>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
                Previous
            </button>
            {% endif %}

            {% for p in page_range %}
                {% if p == page %}
                <span class="btn btn-sm btn-primary">{{ p }}</span>
                {% else %}
                <a href="?page={{ p }}{% if search %}&search={{ search }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="btn btn-sm">{{ p }}</a>
                {% endif %}
            {% endfor %}

            {% if page < total_pages %}
            <a href="?page={{ page|add:'1' }}{% if search %}&search={{ search }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}" class="btn btn-sm">
                Next
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </a>
            {% else %}
            <button class="btn btn-sm" disabled>
                Next
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
        </svg>
        <h3>No customers found</h3>
        <p>{% if search %}Try adjusting your search criteria.{% else %}No customers have registered yet.{% endif %}</p>
    </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="delete-modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content modal-sm">
        <div class="modal-header">
            <h2>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Delete Customer
            </h2>
            <button class="modal-close" id="modal-close">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete this customer?</p>
            <div class="customer-delete-info">
                <div class="delete-info-row">
                    <span class="delete-info-label">Name:</span>
                    <strong id="delete-customer-name"></strong>
                </div>
                <div class="delete-info-row">
                    <span class="delete-info-label">Email:</span>
                    <span id="delete-customer-email"></span>
                </div>
            </div>
            <p class="warning-text">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
                This action cannot be undone. All customer data will be permanently removed.
            </p>
        </div>
        <div class="modal-footer">
            <button class="btn" id="cancel-delete">Cancel</button>
            <button class="btn btn-danger" id="confirm-delete">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Delete Customer
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
window.csrfToken = '{{ csrf_token }}';
</script>
<script src="/static/js/admin/common.js"></script>
<script src="/static/js/admin/customers.js"></script>
{% endblock %}
