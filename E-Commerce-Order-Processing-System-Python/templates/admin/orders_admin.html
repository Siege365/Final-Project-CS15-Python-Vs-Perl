{% extends 'layouts/default.html' %}
{% block title %}Manage Orders - {{ APP_NAME }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
        </svg>
        Manage Orders
    </h1>
    <p class="page-subtitle">View and manage all customer orders.</p>
</div>

<!-- Order Stats -->
<div class="metrics mini">
    <div class="metric-card">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
        </div>
        <h3>Total Orders</h3>
        <div class="value">{{ stats.total_orders }}</div>
    </div>
    <div class="metric-card warning">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        </div>
        <h3>Pending</h3>
        <div class="value">{{ stats.pending_orders }}</div>
    </div>
    <div class="metric-card info">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        </div>
        <h3>Processing</h3>
        <div class="value">{{ stats.processing_orders }}</div>
    </div>
    <div class="metric-card" style="--card-accent: #8b5cf6;">
        <div class="metric-card-icon" style="background: #ede9fe; color: #8b5cf6;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="3" width="15" height="13"></rect>
                <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                <circle cx="5.5" cy="18.5" r="2.5"></circle>
                <circle cx="18.5" cy="18.5" r="2.5"></circle>
            </svg>
        </div>
        <h3>Shipped</h3>
        <div class="value">{{ stats.shipped_orders }}</div>
    </div>
    <div class="metric-card success">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        </div>
        <h3>Delivered</h3>
        <div class="value">{{ stats.delivered_orders }}</div>
    </div>
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: 1.5rem;">
    <form method="GET" class="filters-form">
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
            <div style="flex: 2; min-width: 200px;">
                <label for="search">Search</label>
                <input type="text" id="search" name="search" placeholder="Order # or customer name..." value="{{ search|default:'' }}">
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label for="status">Status</label>
                <select id="status" name="status">
                    <option value="">All Statuses</option>
                    <option value="pending" {% if status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="processing" {% if status == 'processing' %}selected{% endif %}>Processing</option>
                    <option value="shipped" {% if status == 'shipped' %}selected{% endif %}>Shipped</option>
                    <option value="delivered" {% if status == 'delivered' %}selected{% endif %}>Delivered</option>
                    <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label for="date_from">From Date</label>
                <input type="date" id="date_from" name="date_from" value="{{ date_from|default:'' }}">
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label for="date_to">To Date</label>
                <input type="date" id="date_to" name="date_to" value="{{ date_to|default:'' }}">
            </div>
            <div>
                <button type="submit" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                    Filter
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Orders Table -->
<div class="card">
    <div class="card-header">
        <h2>Orders ({{ total_orders }})</h2>
        <div class="bulk-actions" id="bulk-actions" style="display: none;">
            <select id="bulk-action">
                <option value="">Bulk Actions</option>
                <option value="processing">Mark as Processing</option>
                <option value="shipped">Mark as Shipped</option>
                <option value="delivered">Mark as Delivered</option>
                <option value="cancelled">Cancel Orders</option>
            </select>
            <button class="btn btn-sm btn-primary" id="apply-bulk-action">Apply</button>
        </div>
    </div>

    {% if orders %}
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" id="select-all">
                    </th>
                    <th>Order #</th>
                    <th>Customer</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th style="width: 120px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td>
                        <input type="checkbox" class="order-checkbox" value="{{ order.id }}">
                    </td>
                    <td>
                        <a href="{% url 'admin_order_detail' order.id %}" class="order-link">
                            {{ order.order_number }}
                        </a>
                    </td>
                    <td>
                        <div class="customer-info">
                            <strong>{{ order.customer.first_name }} {{ order.customer.last_name }}</strong>
                            <small>{{ order.customer.user.email }}</small>
                        </div>
                    </td>
                    <td>{{ order.items.count }} item{% if order.items.count != 1 %}s{% endif %}</td>
                    <td><strong>${{ order.total|floatformat:2 }}</strong></td>
                    <td>
                        <select class="status-select status {{ order.status }}" data-order-id="{{ order.id }}" data-original="{{ order.status }}">
                            <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Pending</option>
                            <option value="processing" {% if order.status == 'processing' %}selected{% endif %}>Processing</option>
                            <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>Shipped</option>
                            <option value="delivered" {% if order.status == 'delivered' %}selected{% endif %}>Delivered</option>
                            <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                        </select>
                    </td>
                    <td>{{ order.created_at|date:"M j, Y" }}</td>
                    <td>
                        <a href="{% url 'admin_order_detail' order.id %}" class="btn btn-sm" title="View Details">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination-container">
        <div class="pagination">
            {% if page > 1 %}
            <a href="?page={{ page|add:'-1' }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}" class="btn btn-sm">&laquo; Previous</a>
            {% endif %}

            {% for p in page_range %}
                {% if p == page %}
                <span class="btn btn-sm btn-primary">{{ p }}</span>
                {% else %}
                <a href="?page={{ p }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}" class="btn btn-sm">{{ p }}</a>
                {% endif %}
            {% endfor %}

            {% if page < total_pages %}
            <a href="?page={{ page|add:'1' }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}" class="btn btn-sm">Next &raquo;</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
        </svg>
        <h3>No orders found</h3>
        <p>{% if search or status %}Try adjusting your filters.{% else %}No orders have been placed yet.{% endif %}</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('.order-checkbox');
    const bulkActions = document.getElementById('bulk-actions');

    // Select all functionality
    selectAll.addEventListener('change', function() {
        checkboxes.forEach(cb => cb.checked = this.checked);
        updateBulkActions();
    });

    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateBulkActions);
    });

    function updateBulkActions() {
        const checked = document.querySelectorAll('.order-checkbox:checked');
        bulkActions.style.display = checked.length > 0 ? 'flex' : 'none';
    }

    // Bulk action
    document.getElementById('apply-bulk-action').addEventListener('click', function() {
        const action = document.getElementById('bulk-action').value;
        if (!action) {
            alert('Please select an action');
            return;
        }

        const selectedOrders = Array.from(document.querySelectorAll('.order-checkbox:checked'))
            .map(cb => cb.value);

        if (selectedOrders.length === 0) {
            alert('Please select at least one order');
            return;
        }

        if (action === 'cancelled' && !confirm('Are you sure you want to cancel the selected orders?')) {
            return;
        }

        this.disabled = true;
        this.innerHTML = '<span class="spinner-small"></span>';

        fetch('{% url "api_order_bulk_update" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                order_ids: selectedOrders,
                status: action
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Failed to update orders');
                this.disabled = false;
                this.innerHTML = 'Apply';
            }
        })
        .catch(() => {
            alert('An error occurred');
            this.disabled = false;
            this.innerHTML = 'Apply';
        });
    });

    // Individual status change
    document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', function() {
            const orderId = this.dataset.orderId;
            const newStatus = this.value;
            const originalStatus = this.dataset.original;

            // Update visual class
            this.className = 'status-select status ' + newStatus;

            fetch('{% url "api_order_update_status" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    order_id: orderId,
                    status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.dataset.original = newStatus;
                    showToast('Order status updated', 'success');
                } else {
                    this.value = originalStatus;
                    this.className = 'status-select status ' + originalStatus;
                    showToast(data.message || 'Failed to update status', 'error');
                }
            })
            .catch(() => {
                this.value = originalStatus;
                this.className = 'status-select status ' + originalStatus;
                showToast('An error occurred', 'error');
            });
        });
    });
});

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            ${type === 'success' 
                ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>'
                : '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line>'
            }
        </svg>
        <span>${message}</span>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}
