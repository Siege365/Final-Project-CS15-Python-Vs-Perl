{% extends 'layouts/default.html' %}
{% block title %}Manage Orders - {{ APP_NAME }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
        </svg>
        Manage Orders
    </h1>
    <p class="page-subtitle">View and manage all customer orders.</p>
</div>

<!-- Order Stats -->
<div class="metrics mini">
    <div class="metric-card">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
        </div>
        <h3>Total Orders</h3>
        <div class="value">{{ stats.total_orders }}</div>
    </div>
    <div class="metric-card warning">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        </div>
        <h3>Pending</h3>
        <div class="value">{{ stats.pending_orders }}</div>
    </div>
    <div class="metric-card info">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        </div>
        <h3>Processing</h3>
        <div class="value">{{ stats.processing_orders }}</div>
    </div>
    <div class="metric-card" style="--card-accent: #8b5cf6;">
        <div class="metric-card-icon" style="background: #ede9fe; color: #8b5cf6;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="1" y="3" width="15" height="13"></rect>
                <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                <circle cx="5.5" cy="18.5" r="2.5"></circle>
                <circle cx="18.5" cy="18.5" r="2.5"></circle>
            </svg>
        </div>
        <h3>Shipped</h3>
        <div class="value">{{ stats.shipped_orders }}</div>
    </div>
    <div class="metric-card success">
        <div class="metric-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        </div>
        <h3>Delivered</h3>
        <div class="value">{{ stats.delivered_orders }}</div>
    </div>
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: 1.5rem;">
    <form method="GET" class="filters-form">
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
            <div style="flex: 2; min-width: 200px;">
                <label for="search">Search</label>
                <input type="text" id="search" name="search" placeholder="Order # or customer name..." value="{{ search|default:'' }}">
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label for="status">Status</label>
                <select id="status" name="status">
                    <option value="">All Statuses</option>
                    <option value="pending" {% if status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="processing" {% if status == 'processing' %}selected{% endif %}>Processing</option>
                    <option value="shipped" {% if status == 'shipped' %}selected{% endif %}>Shipped</option>
                    <option value="delivered" {% if status == 'delivered' %}selected{% endif %}>Delivered</option>
                    <option value="cancelled" {% if status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label for="date_from">From Date</label>
                <input type="date" id="date_from" name="date_from" value="{{ date_from|default:'' }}">
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label for="date_to">To Date</label>
                <input type="date" id="date_to" name="date_to" value="{{ date_to|default:'' }}">
            </div>
            <div>
                <button type="submit" class="btn btn-primary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                    Filter
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Orders Table -->
<div class="card">
    <div class="card-header">
        <h2>Orders ({{ total_orders }})</h2>
        <div class="bulk-actions" id="bulk-actions" style="display: none;">
            <select id="bulk-action">
                <option value="">Bulk Actions</option>
                <option value="processing">Mark as Processing</option>
                <option value="shipped">Mark as Shipped</option>
                <option value="delivered">Mark as Delivered</option>
                <option value="cancelled">Cancel Orders</option>
            </select>
            <button class="btn btn-sm btn-primary" id="apply-bulk-action">Apply</button>
        </div>
    </div>

    {% if orders %}
    <div class="table-responsive">
        <table>
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" id="select-all">
                    </th>
                    <th>Order #</th>
                    <th>Customer</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Date</th>
                    <th style="width: 80px; text-align: center;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td>
                        <input type="checkbox" class="order-checkbox" value="{{ order.id }}">
                    </td>
                    <td>
                        <a href="{% url 'admin_order_detail' order.id %}" class="order-link">
                            {{ order.order_number }}
                        </a>
                    </td>
                    <td>
                        <div class="customer-info">
                            <strong>{{ order.customer.first_name }} {{ order.customer.last_name }}</strong>
                            <small>{{ order.customer.user.email }}</small>
                        </div>
                    </td>
                    <td>{{ order.items.count }} item{% if order.items.count != 1 %}s{% endif %}</td>
                    <td><strong>${{ order.total|floatformat:2 }}</strong></td>
                    <td>{{ order.created_at|date:"M j, Y" }}</td>
                    <td style="text-align: center;">
                        <div class="kebab-menu">
                            <button class="kebab-btn" title="Actions">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="5" r="1"></circle>
                                    <circle cx="12" cy="12" r="1"></circle>
                                    <circle cx="12" cy="19" r="1"></circle>
                                </svg>
                            </button>
                            <div class="kebab-dropdown">
                                <a href="{% url 'admin_order_detail' order.id %}" class="kebab-item">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                    View Order
                                </a>
                                <button class="kebab-item status-change-btn" data-order-id="{{ order.id }}" data-current-status="{{ order.status }}">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="3"></circle>
                                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                    </svg>
                                    Update Status <span class="status-badge-mini {{ order.status }}">{{ order.status|title }}</span>
                                </button>
                                <button class="kebab-item danger delete-order-btn" data-order-id="{{ order.id }}" data-order-number="{{ order.order_number }}">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                    Delete Order
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="pagination-container">
        <div class="pagination">
            {% if page > 1 %}
            <a href="?page={{ page|add:'-1' }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}" class="btn btn-sm">&laquo; Previous</a>
            {% endif %}

            {% for p in page_range %}
                {% if p == page %}
                <span class="btn btn-sm btn-primary">{{ p }}</span>
                {% else %}
                <a href="?page={{ p }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}" class="btn btn-sm">{{ p }}</a>
                {% endif %}
            {% endfor %}

            {% if page < total_pages %}
            <a href="?page={{ page|add:'1' }}{% if search %}&search={{ search }}{% endif %}{% if status %}&status={{ status }}{% endif %}" class="btn btn-sm">Next &raquo;</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
        </svg>
        <h3>No orders found</h3>
        <p>{% if search or status %}Try adjusting your filters.{% else %}No orders have been placed yet.{% endif %}</p>
    </div>
    {% endif %}
</div>

<!-- Status Change Modal -->
<div class="modal" id="status-modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Update Order Status</h3>
            <button class="modal-close" id="status-modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p>Change status for order <strong id="status-order-number"></strong></p>
            <div style="margin-top: 1rem;">
                <label for="new-status">New Status</label>
                <select id="new-status" class="form-control">
                    <option value="pending">Pending</option>
                    <option value="processing">Processing</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn" id="status-cancel">Cancel</button>
            <button class="btn btn-primary" id="status-confirm">Update Status</button>
        </div>
    </div>
</div>

<!-- Delete Order Modal -->
<div class="modal" id="delete-order-modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3>Delete Order</h3>
            <button class="modal-close" id="delete-order-modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete order <strong id="delete-order-number"></strong>?</p>
            <p class="text-error">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="btn" id="delete-order-cancel">Cancel</button>
            <button class="btn btn-danger" id="delete-order-confirm">Delete Order</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
window.orderUrls = {
    bulkUpdate: '{% url "api_order_bulk_update" %}',
    updateStatus: '{% url "api_order_update_status" %}',
    deleteOrder: '{% url "admin_order_delete" 0 %}'.replace('/0/', '/')
};
window.csrfToken = '{{ csrf_token }}';
</script>
<script src="/static/js/admin/orders-list.js?v=20251212-001"></script>
{% endblock %}
